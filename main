import requests
import time
import pandas as pd
import os
import logging
import urllib3
from datetime import datetime
import hashlib


BOT_TOKEN = '8286920710:AAHgOzxIRaOsBLRs5kK58Cmadns3CUvDDEs'  # –ó–∞–º–µ–Ω–∏—Ç–µ!
CHAT_ID = '-5039280407'      # –ó–∞–º–µ–Ω–∏—Ç–µ!

CSV_DOWNLOAD_URL = 'https://192.168.9.17:8443/ips/alerts'

PARAMS = {
    'filter': '[{"items":[{"column_name":"date_time","operator":"date_range","value":["hour"]}],"link_operator":"and"}]',
    'format_type': 'CSV',
    'sort': '[{"field":"date_time","direction":"desc"}]'
}

login = admin
password = Cnfkbyuhfl2025!

CHECK_INTERVAL = 30  # –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
LAST_EVENT_FILE = 'last_event.txt'
LOG_FILE = 'monitor.log'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)

# ============ –§–£–ù–ö–¶–ò–ò ============

def send_telegram_message(text):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram"""
    try:
        url = f'https://api.telegram.org/bot{BOT_TOKEN}/sendMessage'
        payload = {
            'chat_id': CHAT_ID,
            'text': text,
            'parse_mode': 'HTML'
        }
        response = requests.post(url, json=payload, timeout=10)
        
        if response.status_code == 200:
            logging.info("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram")
            return True
        else:
            logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.text}")
            return False
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram: {e}")
        return False

def get_last_event_id():
    """–ü–æ–ª—É—á–∏—Ç—å ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è"""
    if os.path.exists(LAST_EVENT_FILE):
        try:
            with open(LAST_EVENT_FILE, 'r') as f:
                return f.read().strip()
        except:
            return None
    return None

def save_last_event_id(event_id):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è"""
    try:
        with open(LAST_EVENT_FILE, 'w') as f:
            f.write(str(event_id))
        logging.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω ID —Å–æ–±—ã—Ç–∏—è: {event_id}")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ID: {e}")

def download_csv():
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV —Ñ–∞–π–ª–∞ —Å —Å–æ–±—ã—Ç–∏—è–º–∏"""
    try:
        session = requests.Session()
        session.verify = False  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º SSL –æ—à–∏–±–∫–∏
        
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'text/csv,application/csv,application/octet-stream',
            'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7'
        }
        
        logging.info("–°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV —Ñ–∞–π–ª–∞...")
        
        response = session.get(
            CSV_DOWNLOAD_URL,
            params=PARAMS,
            headers=headers,
            timeout=30,
            verify=False
        )
        
        response.raise_for_status()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ CSV
        content_type = response.headers.get('content-type', '').lower()
        if 'csv' not in content_type and 'octet-stream' not in content_type:
            logging.warning(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π Content-Type: {content_type}")
            logging.info(f"–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞: {response.text[:100]}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        temp_file = f"temp_events_{datetime.now().strftime('%H%M%S')}.csv"
        with open(temp_file, 'wb') as f:
            f.write(response.content)
        
        logging.info(f"CSV —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ {temp_file}, —Ä–∞–∑–º–µ—Ä: {len(response.content)} –±–∞–π—Ç")
        
        return temp_file
        
    except requests.exceptions.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV: {e}")
        return None
    except Exception as e:
        logging.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return None

def parse_csv_file(file_path):
    """–ß—Ç–µ–Ω–∏–µ –∏ –ø–∞—Ä—Å–∏–Ω–≥ CSV —Ñ–∞–π–ª–∞"""
    try:
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –∫–æ–¥–∏—Ä–æ–≤–∫–∏
        encodings = ['utf-8', 'cp1251', 'windows-1251', 'iso-8859-1']
        
        for encoding in encodings:
            try:
                df = pd.read_csv(file_path, encoding=encoding)
                logging.info(f"CSV —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π {encoding}")
                
                # –í—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                logging.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ CSV: {list(df.columns)}")
                
                # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                if len(df) > 0:
                    logging.info(f"–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞:\n{df.iloc[0].to_dict()}")
                
                return df
            except UnicodeDecodeError:
                continue
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π {encoding}: {e}")
                continue
        
        # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –Ω–µ –ø–æ–¥–æ—à–ª–∞, –ø—Ä–æ–±—É–µ–º –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏
        try:
            df = pd.read_csv(file_path)
            return df
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å CSV –Ω–∏ —Å –æ–¥–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π: {e}")
            return None
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV: {e}")
        return None

def decode_russian_text(text):
    """–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É—Å—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫ –∏–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏"""
    if not isinstance(text, str):
        return text
    
    # –ü—Ä–æ–±—É–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É
    try:
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if any(ord(c) > 127 for c in text):
            # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
            try:
                return text.encode('cp1251').decode('utf-8')
            except:
                try:
                    return text.encode('iso-8859-1').decode('utf-8')
                except:
                    return text
        return text
    except:
        return text

def parse_event_row(row):
    """–ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ —Å–æ–±—ã—Ç–∏—è –∏–∑ CSV"""
    try:
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å–æ–±—ã—Ç–∏—è
        event = {
            'id': str(row.get('sid', '')),  # ID —Å–æ–±—ã—Ç–∏—è
            'time': str(row.get('date_time', '')),
            'description': decode_russian_text(str(row.get('description', ''))),
            'severity_raw': str(row.get('severity', '')),
            'severity': get_severity_name(row.get('severity', '')),
            'protocol': str(row.get('protocol', '')),
            'source_ip': str(row.get('source_ip', '')),
            'source_port': str(row.get('source_port', '')),
            'source_country': decode_russian_text(str(row.get('source_country', ''))),
            'destination_ip': str(row.get('destination_ip', '')),
            'destination_port': str(row.get('destination_port', '')),
            'destination_country': decode_russian_text(str(row.get('destination_country', ''))),
            'security_event': decode_russian_text(str(row.get('security_event', ''))),
            'result': str(row.get('result', ''))
        }
        
        # –ï—Å–ª–∏ ID –ø—É—Å—Ç–æ–π, —Å–æ–∑–¥–∞–µ–º —Ö—ç—à –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        if not event['id'] or event['id'] == 'nan':
            event_str = f"{event['time']}{event['source_ip']}{event['destination_ip']}"
            event['id'] = hashlib.md5(event_str.encode()).hexdigest()[:10]
        
        return event
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä–æ–∫–∏ —Å–æ–±—ã—Ç–∏—è: {e}")
        logging.error(f"–°—Ç—Ä–æ–∫–∞: {row.to_dict()}")
        return None

def get_severity_name(severity_code):
    """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ –≤ —Ç–µ–∫—Å—Ç"""
    severity_map = {
        '1': '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π',
        '2': '–í—ã—Å–æ–∫–∏–π', 
        '3': '–°—Ä–µ–¥–Ω–∏–π',
        '4': '–ù–∏–∑–∫–∏–π',
        '5': '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π',
        '3.0': '–°—Ä–µ–¥–Ω–∏–π',
        '3': '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π'  # –í –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ 3 = –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π
    }
    severity_str = str(severity_code)
    return severity_map.get(severity_str, f"–£—Ä–æ–≤–µ–Ω—å {severity_str}")

def format_telegram_message(event):
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram"""
    
    # –í—ã–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –ø–æ —É—Ä–æ–≤–Ω—é –≤–∞–∂–Ω–æ—Å—Ç–∏
    severity_emoji = {
        '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π': 'üî¥',
        '–í—ã—Å–æ–∫–∏–π': 'üü†', 
        '–°—Ä–µ–¥–Ω–∏–π': 'üü°',
        '–ù–∏–∑–∫–∏–π': 'üîµ',
        '–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π': '‚ö™'
    }
    
    emoji = severity_emoji.get(event['severity'], '‚ö™')
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è
    try:
        event_time = event['time'].split('.')[0]  # –£–±–∏—Ä–∞–µ–º –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
    except:
        event_time = event['time']
    
    # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = f"{emoji} <b>–ù–û–í–û–ï –°–û–ë–´–¢–ò–ï –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò</b>\n\n"
    message += f"<b>üïí –í—Ä–µ–º—è:</b> {event_time}\n"
    message += f"<b>‚ö†Ô∏è –£—Ä–æ–≤–µ–Ω—å:</b> {event['severity']}\n"
    message += f"<b>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</b> {event['description']}\n"
    message += f"<b>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:</b> {event['result']}\n"
    message += f"<b>üìç –ò—Å—Ç–æ—á–Ω–∏–∫:</b>\n"
    message += f"  ‚Ä¢ IP: {event['source_ip']}:{event['source_port']}\n"
    message += f"  ‚Ä¢ –°—Ç—Ä–∞–Ω–∞: {event['source_country']}\n"
    message += f"<b>üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</b>\n"
    message += f"  ‚Ä¢ IP: {event['destination_ip']}:{event['destination_port']}\n"
    message += f"  ‚Ä¢ –°—Ç—Ä–∞–Ω–∞: {event['destination_country']}\n"
    message += f"<b>üì° –ü—Ä–æ—Ç–æ–∫–æ–ª:</b> {event['protocol']}\n"
    message += f"<b>üîß –°–æ–±—ã—Ç–∏–µ:</b> {event['security_event']}\n"
    message += f"\n<code>ID: {event['id']}</code>"
    
    return message

def check_new_events():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π"""
    logging.info("=" * 50)
    logging.info("–ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π...")
    
    # –°–∫–∞—á–∏–≤–∞–µ–º CSV
    csv_file = download_csv()
    if not csv_file:
        logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å CSV —Ñ–∞–π–ª")
        return
    
    try:
        # –ü–∞—Ä—Å–∏–º CSV
        df = parse_csv_file(csv_file)
        if df is None or df.empty:
            logging.warning("CSV —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω")
            return
        
        logging.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} —Å–æ–±—ã—Ç–∏–π –∏–∑ CSV")
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–∞–º—ã–µ –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–µ)
        if 'date_time' in df.columns:
            df = df.sort_values('date_time', ascending=False)
        
        # –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ
        latest_row = df.iloc[0]
        event = parse_event_row(latest_row)
        
        if not event:
            logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
        last_id = get_last_event_id()
        current_id = event['id']
        
        logging.info(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ ID: {last_id}")
        logging.info(f"–¢–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ ID: {current_id}")
        
        if last_id != current_id:
            logging.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ: {current_id}")
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            telegram_message = format_telegram_message(event)
            
            if send_telegram_message(telegram_message):
                save_last_event_id(current_id)
                logging.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–±—ã—Ç–∏—è {current_id}")
            else:
                logging.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ")
        else:
            logging.info("–ù–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")
            
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–±—ã—Ç–∏–π: {e}", exc_info=True)
    
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        try:
            if os.path.exists(csv_file):
                os.remove(csv_file)
                logging.info(f"–í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª {csv_file} —É–¥–∞–ª–µ–Ω")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {e}")

def first_run_setup():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ"""
    logging.info("–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∞...")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_telegram_message("üü¢ <b>–ú–æ–Ω–∏—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—â–µ–Ω</b>\n\n–°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∞–ª–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π IDECO IPS.")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ ID
    csv_file = download_csv()
    if csv_file:
        df = parse_csv_file(csv_file)
        if df is not None and not df.empty:
            latest_row = df.iloc[0]
            event = parse_event_row(latest_row)
            if event:
                save_last_event_id(event['id'])
                logging.info(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π ID: {event['id']}")
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            try:
                os.remove(csv_file)
            except:
                pass

def main():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    logging.info("=" * 60)
    logging.info("–ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ê –°–û–ë–´–¢–ò–ô IDECO IPS")
    logging.info("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    if BOT_TOKEN == '–í–ê–®_BOT_TOKEN':
        logging.error("–ù–µ —É–∫–∞–∑–∞–Ω BOT_TOKEN! –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather")
        return
    
    if CHAT_ID == '–í–ê–®_CHAT_ID':
        logging.error("–ù–µ —É–∫–∞–∑–∞–Ω CHAT_ID! –ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ /getUpdates")
        return
    
    # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    first_run_setup()
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    cycle_count = 0
    try:
        while True:
            cycle_count += 1
            logging.info(f"–¶–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ #{cycle_count}")
            
            check_new_events()
            
            # –û–∂–∏–¥–∞–Ω–∏–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º –≤ –∫–æ–Ω—Å–æ–ª–∏
            for i in range(CHECK_INTERVAL):
                time.sleep(1)
                if i % 10 == 0:
                    remaining = CHECK_INTERVAL - i
                    print(f"–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑: {remaining:3d} —Å–µ–∫.", end='\r')
            
            print()  # –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            
    except KeyboardInterrupt:
        logging.info("\n–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
        send_telegram_message("üî¥ <b>–ú–æ–Ω–∏—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>\n\n–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π –ø—Ä–µ–∫—Ä–∞—â–µ–Ω.")
    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}", exc_info=True)

if __name__ == "__main__":
    main()
