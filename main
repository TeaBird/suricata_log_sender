import requests
import time
import pandas as pd
import os
import logging
import urllib3
from datetime import datetime
import hashlib

# ============ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ============
# –í–°–ï –ß–£–í–°–¢–í–ò–¢–ï–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –í –ü–ï–†–ï–ú–ï–ù–ù–´–• –°–†–ï–î–´!
BOT_TOKEN = os.environ.get('BOT_TOKEN')
CHAT_ID = os.environ.get('CHAT_ID')
IDECO_USERNAME = os.environ.get('IDECO_USERNAME')
IDECO_PASSWORD = os.environ.get('IDECO_PASSWORD')
CSV_DOWNLOAD_URL = os.environ.get('CSV_DOWNLOAD_URL')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
REQUIRED_ENV_VARS = ['BOT_TOKEN', 'CHAT_ID', 'CSV_DOWNLOAD_URL']
missing_vars = [var for var in REQUIRED_ENV_VARS if not os.environ.get(var)]
if missing_vars:
    print(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: {missing_vars}")
    print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤ Railway Dashboard: railway variables set NAME=value")
    sys.exit(1)

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
PARAMS = {
    'filter': '[{"items":[{"column_name":"date_time","operator":"date_range","value":["hour"]}],"link_operator":"and"}]',
    'format_type': 'CSV',
    'sort': '[{"field":"date_time","direction":"desc"}]'
}

CHECK_INTERVAL = 60  # –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
LAST_EVENT_FILE = '/tmp/last_event.txt'  # Railway –∏—Å–ø–æ–ª—å–∑—É–µ—Ç /tmp –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
LOG_FILE = '/tmp/monitor.log'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE),
        logging.StreamHandler()
    ]
)

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è SSL
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ============ –§–£–ù–ö–¶–ò–ò (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ============
# ... –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –≤–∞—à–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ ...

def main():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    print("=" * 60)
    print("üöÄ –ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ê –°–û–ë–´–¢–ò–ô –ù–ê RAILWAY")
    print("=" * 60)
    print(f"üì± Chat ID: {CHAT_ID}")
    print(f"üåê URL: {CSV_DOWNLOAD_URL}")
    print(f"‚è± –ò–Ω—Ç–µ—Ä–≤–∞–ª: {CHECK_INTERVAL} —Å–µ–∫")
    print("=" * 60)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_telegram_message("üöÄ <b>–ú–æ–Ω–∏—Ç–æ—Ä —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—â–µ–Ω –Ω–∞ Railway</b>")
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    while True:
        try:
            check_new_events()
            time.sleep(CHECK_INTERVAL)
        except KeyboardInterrupt:
            break
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞: {e}")
            time.sleep(60)

if __name__ == "__main__":
    main()
